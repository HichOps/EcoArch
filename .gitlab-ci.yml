# Pipeline Master - EcoArch FinOps Platform
stages:
  - plan
  - finops

variables:
  TF_ROOT: "infra"
  GCP_WIF_PROVIDER: "projects/514436528658/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider"
  GCP_SERVICE_ACCOUNT: "ecoarch-ci@ecoarch-mvp-1768828854.iam.gserviceaccount.com"
  TF_VAR_project_id: "ecoarch-mvp-1768828854"
  TF_VAR_region: "us-central1"
  TF_VAR_zone: "us-central1-a"
  TERRAFORM_VERSION: "1.10.0"
  PYTHON_VERSION: "3.11.10-slim"
  INFRACOST_VERSION: "v0.10.43"

.gcp_auth:
  id_tokens:
    GCP_ID_TOKEN:
      aud: https://iam.googleapis.com/projects/514436528658/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider
  before_script: &gcp_setup
    - echo "${GCP_ID_TOKEN}" > ${CI_PROJECT_DIR}/.google_id_token
    - |
      echo "{
        \"type\": \"external_account\",
        \"audience\": \"//iam.googleapis.com/projects/514436528658/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider\",
        \"subject_token_type\": \"urn:ietf:params:oauth:token-type:jwt\",
        \"token_url\": \"https://sts.googleapis.com/v1/token\",
        \"service_account_impersonation_url\": \"https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${GCP_SERVICE_ACCOUNT}:generateAccessToken\",
        \"credential_source\": { \"file\": \"${CI_PROJECT_DIR}/.google_id_token\" }
      }" > ${CI_PROJECT_DIR}/.google_creds.json
    - export GOOGLE_APPLICATION_CREDENTIALS=${CI_PROJECT_DIR}/.google_creds.json

terraform_plan:
  extends: .gcp_auth
  stage: plan
  image:
    name: hashicorp/terraform:${TERRAFORM_VERSION}
    entrypoint: [""] 
  script:
    - cd $TF_ROOT
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}" -backend-config="prefix=${TF_STATE_PREFIX}"
    - terraform plan -out=../tfplan.binary
    - terraform show -json ../tfplan.binary > ../plan.json
  artifacts:
    paths:
      - plan.json
      - tfplan.binary
    expire_in: 1 hour

infracost_analysis:
  extends: .gcp_auth
  stage: finops
  image: python:${PYTHON_VERSION}
  before_script:
    - *gcp_setup
    # Installation des outils systèmes
    - apt-get update && apt-get install -y curl unzip
    # 1. Installation Infracost
    - curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh -s -- -v ${INFRACOST_VERSION}
    # 2. Installation Terraform + Mise en PATH (Indispensable pour décoder le binaire)
    - |
      curl -fsSL https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip -o terraform.zip
      unzip terraform.zip
      chmod +x terraform
      mv terraform /usr/local/bin/
    # 3. Préparation environnement Python
    - pip install --no-cache-dir -r requirements.txt
    - export PYTHONPATH=. 
  script:
    # On entre dans le dossier infra pour qu'Infracost trouve les fichiers .tf
    - cd $TF_ROOT
    # ASTUCE CRITIQUE : On initialise sans backend pour récupérer les plugins Providers (Google)
    # sans avoir besoin de s'authentifier au bucket GCS ici.
    - terraform init -backend=false
    # Analyse du binaire (remontée d'un cran avec ../ car on est dans infra/)
    - infracost breakdown --path ../tfplan.binary --format json --out-file ../infracost-report.json
    - cd ..
    # Exécution des scripts de reporting
    - pytest tests/
    - python src/parser.py > report.md
    - python src/gitlab_comment.py
    - python src/budget_gate.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    paths:
      - infracost-report.json
      - report.md
    expire_in: 1 week